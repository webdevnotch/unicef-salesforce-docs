import{_ as s,c as a,o as e,a as n}from"./app.5dbd4e2d.js";const h=JSON.parse('{"title":"Cron Job State Persistence","description":"","frontmatter":{},"headers":[{"level":2,"title":"\u2705 Problem Solved","slug":"\u2705-problem-solved","link":"#\u2705-problem-solved","children":[]},{"level":2,"title":"\u{1F5C4}\uFE0F How It Works","slug":"\u{1F5C4}\uFE0F-how-it-works","link":"#\u{1F5C4}\uFE0F-how-it-works","children":[{"level":3,"title":"Storage Location","slug":"storage-location","link":"#storage-location","children":[]},{"level":3,"title":"Database Schema","slug":"database-schema","link":"#database-schema","children":[]}]},{"level":2,"title":"\u{1F504} Lifecycle","slug":"\u{1F504}-lifecycle","link":"#\u{1F504}-lifecycle","children":[{"level":3,"title":"Startup (onModuleInit)","slug":"startup-onmoduleinit","link":"#startup-onmoduleinit","children":[]},{"level":3,"title":"During Runtime","slug":"during-runtime","link":"#during-runtime","children":[]},{"level":3,"title":"Shutdown & Restart","slug":"shutdown-restart","link":"#shutdown-restart","children":[]}]},{"level":2,"title":"\u{1F4CA} Features","slug":"\u{1F4CA}-features","link":"#\u{1F4CA}-features","children":[{"level":3,"title":"\u2705 Persistence","slug":"\u2705-persistence","link":"#\u2705-persistence","children":[]},{"level":3,"title":"\u2705 Performance","slug":"\u2705-performance","link":"#\u2705-performance","children":[]},{"level":3,"title":"\u2705 Reliability","slug":"\u2705-reliability","link":"#\u2705-reliability","children":[]},{"level":3,"title":"\u2705 Auto-initialization","slug":"\u2705-auto-initialization","link":"#\u2705-auto-initialization","children":[]}]},{"level":2,"title":"\u{1F50D} Example Flow","slug":"\u{1F50D}-example-flow","link":"#\u{1F50D}-example-flow","children":[{"level":3,"title":"First Server Start","slug":"first-server-start","link":"#first-server-start","children":[]},{"level":3,"title":"Disable Pledge Jobs","slug":"disable-pledge-jobs","link":"#disable-pledge-jobs","children":[]},{"level":3,"title":"Server Restart","slug":"server-restart","link":"#server-restart","children":[]},{"level":3,"title":"Re-enable Pledge Jobs","slug":"re-enable-pledge-jobs","link":"#re-enable-pledge-jobs","children":[]}]},{"level":2,"title":"\u{1F3AF} Code Changes","slug":"\u{1F3AF}-code-changes","link":"#\u{1F3AF}-code-changes","children":[{"level":3,"title":"CronJobStateService","slug":"cronjobstateservice","link":"#cronjobstateservice","children":[]}]},{"level":2,"title":"\u{1F4CB} Database Queries","slug":"\u{1F4CB}-database-queries","link":"#\u{1F4CB}-database-queries","children":[{"level":3,"title":"Check Current States","slug":"check-current-states","link":"#check-current-states","children":[]},{"level":3,"title":"Manually Update State","slug":"manually-update-state","link":"#manually-update-state","children":[]},{"level":3,"title":"Reset to Defaults","slug":"reset-to-defaults","link":"#reset-to-defaults","children":[]}]},{"level":2,"title":"\u2705 Verification","slug":"\u2705-verification","link":"#\u2705-verification","children":[]},{"level":2,"title":"\u{1F389} Summary","slug":"\u{1F389}-summary","link":"#\u{1F389}-summary","children":[]}],"relativePath":"backend/PERSISTENCE_IMPLEMENTED.md"}'),l={name:"backend/PERSISTENCE_IMPLEMENTED.md"},o=n(`<h1 id="cron-job-state-persistence" tabindex="-1">Cron Job State Persistence <a class="header-anchor" href="#cron-job-state-persistence" aria-hidden="true">#</a></h1><h2 id="\u2705-problem-solved" tabindex="-1">\u2705 Problem Solved <a class="header-anchor" href="#\u2705-problem-solved" aria-hidden="true">#</a></h2><p><strong>Issue</strong>: Cron job enabled/disabled state was lost on server restart (only stored in memory)</p><p><strong>Solution</strong>: Implemented persistent storage in database using <code>SystemSetting</code> table</p><hr><h2 id="\u{1F5C4}\uFE0F-how-it-works" tabindex="-1">\u{1F5C4}\uFE0F How It Works <a class="header-anchor" href="#\u{1F5C4}\uFE0F-how-it-works" aria-hidden="true">#</a></h2><h3 id="storage-location" tabindex="-1">Storage Location <a class="header-anchor" href="#storage-location" aria-hidden="true">#</a></h3><ul><li><strong>Table</strong>: <code>SystemSetting</code></li><li><strong>Category</strong>: <code>cronJobs</code></li><li><strong>Keys</strong>: <code>pledge</code>, <code>oneoff</code>, <code>recurring</code>, <code>hourly</code></li><li><strong>Value Type</strong>: <code>boolean</code></li></ul><h3 id="database-schema" tabindex="-1">Database Schema <a class="header-anchor" href="#database-schema" aria-hidden="true">#</a></h3><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">SystemSetting</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> category </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">cronJobs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">-- Results:</span></span>
<span class="line"><span style="color:#A6ACCD;">id                | category  | </span><span style="color:#F78C6C;">key</span><span style="color:#A6ACCD;">       | </span><span style="color:#F78C6C;">value</span><span style="color:#A6ACCD;"> | valueType</span></span>
<span class="line"><span style="color:#676E95;">------------------|-----------|-----------|-------|----------</span></span>
<span class="line"><span style="color:#A6ACCD;">clx123...         | cronJobs  | pledge    | true  | </span><span style="color:#C792EA;">boolean</span></span>
<span class="line"><span style="color:#A6ACCD;">clx456...         | cronJobs  | oneoff    | false | </span><span style="color:#C792EA;">boolean</span></span>
<span class="line"><span style="color:#A6ACCD;">clx789...         | cronJobs  | recurring | true  | </span><span style="color:#C792EA;">boolean</span></span>
<span class="line"><span style="color:#A6ACCD;">clxabc...         | cronJobs  | hourly    | true  | </span><span style="color:#C792EA;">boolean</span></span>
<span class="line"></span></code></pre></div><hr><h2 id="\u{1F504}-lifecycle" tabindex="-1">\u{1F504} Lifecycle <a class="header-anchor" href="#\u{1F504}-lifecycle" aria-hidden="true">#</a></h2><h3 id="startup-onmoduleinit" tabindex="-1">Startup (onModuleInit) <a class="header-anchor" href="#startup-onmoduleinit" aria-hidden="true">#</a></h3><ol><li>Load states from database</li><li>If none exist \u2192 create default settings (all enabled)</li><li>Load into memory for fast access</li><li>Log success/failure</li></ol><h3 id="during-runtime" tabindex="-1">During Runtime <a class="header-anchor" href="#during-runtime" aria-hidden="true">#</a></h3><ul><li>States checked from in-memory (fast)</li><li>Changes persisted to database immediately</li><li>Database serves as source of truth</li></ul><h3 id="shutdown-restart" tabindex="-1">Shutdown &amp; Restart <a class="header-anchor" href="#shutdown-restart" aria-hidden="true">#</a></h3><ul><li>Memory cleared</li><li>On next startup \u2192 reload from database</li><li>Your settings are preserved!</li></ul><hr><h2 id="\u{1F4CA}-features" tabindex="-1">\u{1F4CA} Features <a class="header-anchor" href="#\u{1F4CA}-features" aria-hidden="true">#</a></h2><h3 id="\u2705-persistence" tabindex="-1">\u2705 Persistence <a class="header-anchor" href="#\u2705-persistence" aria-hidden="true">#</a></h3><ul><li>Settings survive server restarts</li><li>Database is source of truth</li><li>Auto-initialization on first run</li></ul><h3 id="\u2705-performance" tabindex="-1">\u2705 Performance <a class="header-anchor" href="#\u2705-performance" aria-hidden="true">#</a></h3><ul><li>In-memory cache for speed</li><li>Database write on change only</li><li>Fast reads during runtime</li></ul><h3 id="\u2705-reliability" tabindex="-1">\u2705 Reliability <a class="header-anchor" href="#\u2705-reliability" aria-hidden="true">#</a></h3><ul><li>Fallback to defaults if database fails</li><li>Graceful error handling</li><li>Continues working even if DB is down (memory only)</li></ul><h3 id="\u2705-auto-initialization" tabindex="-1">\u2705 Auto-initialization <a class="header-anchor" href="#\u2705-auto-initialization" aria-hidden="true">#</a></h3><ul><li>Creates default settings on first run</li><li>All jobs start enabled by default</li><li>No manual setup required</li></ul><hr><h2 id="\u{1F50D}-example-flow" tabindex="-1">\u{1F50D} Example Flow <a class="header-anchor" href="#\u{1F50D}-example-flow" aria-hidden="true">#</a></h2><h3 id="first-server-start" tabindex="-1">First Server Start <a class="header-anchor" href="#first-server-start" aria-hidden="true">#</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">1. Load from DB \u2192 No records found</span></span>
<span class="line"><span style="color:#A6ACCD;">2. Create defaults \u2192 All enabled</span></span>
<span class="line"><span style="color:#A6ACCD;">3. Store in DB</span></span>
<span class="line"><span style="color:#A6ACCD;">4. Load into memory</span></span>
<span class="line"><span style="color:#A6ACCD;">\u2705 Ready!</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h3 id="disable-pledge-jobs" tabindex="-1">Disable Pledge Jobs <a class="header-anchor" href="#disable-pledge-jobs" aria-hidden="true">#</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">1. User toggles pledge job to OFF</span></span>
<span class="line"><span style="color:#A6ACCD;">2. Update memory: pledge = false</span></span>
<span class="line"><span style="color:#A6ACCD;">3. Persist to DB: UPSERT SystemSetting</span></span>
<span class="line"><span style="color:#A6ACCD;">4. Log: &quot;Cron job pledge disabled&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">\u2705 Saved!</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h3 id="server-restart" tabindex="-1">Server Restart <a class="header-anchor" href="#server-restart" aria-hidden="true">#</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">1. Load from DB \u2192 Loads pledge = false</span></span>
<span class="line"><span style="color:#A6ACCD;">2. Load into memory</span></span>
<span class="line"><span style="color:#A6ACCD;">3. Pledge jobs skip execution</span></span>
<span class="line"><span style="color:#A6ACCD;">\u2705 Settings preserved!</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h3 id="re-enable-pledge-jobs" tabindex="-1">Re-enable Pledge Jobs <a class="header-anchor" href="#re-enable-pledge-jobs" aria-hidden="true">#</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">1. User toggles pledge job to ON</span></span>
<span class="line"><span style="color:#A6ACCD;">2. Update memory: pledge = true</span></span>
<span class="line"><span style="color:#A6ACCD;">3. Persist to DB: UPSERT SystemSetting</span></span>
<span class="line"><span style="color:#A6ACCD;">4. Next scheduled run \u2192 Job executes</span></span>
<span class="line"><span style="color:#A6ACCD;">\u2705 Back online!</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><hr><h2 id="\u{1F3AF}-code-changes" tabindex="-1">\u{1F3AF} Code Changes <a class="header-anchor" href="#\u{1F3AF}-code-changes" aria-hidden="true">#</a></h2><h3 id="cronjobstateservice" tabindex="-1">CronJobStateService <a class="header-anchor" href="#cronjobstateservice" aria-hidden="true">#</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// Before: In-memory only</span></span>
<span class="line"><span style="color:#A6ACCD;">private jobStates </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Map</span><span style="color:#A6ACCD;">([</span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;">])</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// After: Persistent with DB</span></span>
<span class="line"><span style="color:#A6ACCD;">async </span><span style="color:#82AAFF;">onModuleInit</span><span style="color:#A6ACCD;">() </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">loadStatesFromDatabase</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">async </span><span style="color:#82AAFF;">setJobEnabled</span><span style="color:#A6ACCD;">(jobType: string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> enabled: boolean) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// Memory + Database</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">jobStates</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">jobType</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">enabled</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">prisma</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">systemSetting</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">upsert</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{...}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><hr><h2 id="\u{1F4CB}-database-queries" tabindex="-1">\u{1F4CB} Database Queries <a class="header-anchor" href="#\u{1F4CB}-database-queries" aria-hidden="true">#</a></h2><h3 id="check-current-states" tabindex="-1">Check Current States <a class="header-anchor" href="#check-current-states" aria-hidden="true">#</a></h3><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">key</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">value</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">SystemSetting</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> category </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">cronJobs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">-- Output:</span></span>
<span class="line"><span style="color:#F78C6C;">key</span><span style="color:#A6ACCD;">       | </span><span style="color:#F78C6C;">value</span></span>
<span class="line"><span style="color:#676E95;">----------|-------</span></span>
<span class="line"><span style="color:#A6ACCD;">pledge    | true</span></span>
<span class="line"><span style="color:#A6ACCD;">oneoff    | false</span></span>
<span class="line"><span style="color:#A6ACCD;">recurring | true</span></span>
<span class="line"><span style="color:#A6ACCD;">hourly    | true</span></span>
<span class="line"></span></code></pre></div><h3 id="manually-update-state" tabindex="-1">Manually Update State <a class="header-anchor" href="#manually-update-state" aria-hidden="true">#</a></h3><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki"><code><span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">SystemSetting</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">value</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">false</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">updatedAt</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOW</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> category </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">cronJobs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AND</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">key</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">pledge</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span></code></pre></div><h3 id="reset-to-defaults" tabindex="-1">Reset to Defaults <a class="header-anchor" href="#reset-to-defaults" aria-hidden="true">#</a></h3><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki"><code><span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">SystemSetting</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">value</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">true</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">updatedAt</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOW</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> category </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">cronJobs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span></code></pre></div><hr><h2 id="\u2705-verification" tabindex="-1">\u2705 Verification <a class="header-anchor" href="#\u2705-verification" aria-hidden="true">#</a></h2><p>Test the persistence:</p><ol><li><strong>Start server</strong>: All jobs enabled by default</li><li><strong>Disable a job</strong>: Use API or dashboard</li><li><strong>Restart server</strong>: <code>npm run start:dev</code></li><li><strong>Check</strong>: Job remains disabled \u2705</li></ol><hr><h2 id="\u{1F389}-summary" tabindex="-1">\u{1F389} Summary <a class="header-anchor" href="#\u{1F389}-summary" aria-hidden="true">#</a></h2><p><strong>Problem</strong>: Settings lost on restart \u274C<br><strong>Solution</strong>: Database persistence \u2705<br><strong>Result</strong>: Your on/off settings survive restarts! \u{1F389}</p>`,57),t=[o];function r(p,c,i,d,y,C){return e(),a("div",null,t)}const u=s(l,[["render",r]]);export{h as __pageData,u as default};
